<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Feature Service Status</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 1rem 2rem;
      background: #0b1020;
      color: #f2f2f2;
    }
    h1 {
      margin-top: 0;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 1.0rem;
      gap: 1rem;
      flex-wrap: wrap;
    }
    .meta {
      font-size: 0.9rem;
      opacity: 0.85;
    }

    .health-bar {
      padding: 0.6rem 0.9rem;
      border-radius: 0.6rem;
      display: inline-flex;
      align-items: center;
      gap: 0.6rem;
      font-size: 0.9rem;
      font-weight: 600;
    }
    .health-ok {
      background: #093022;
      color: #6cf5b2;
      border: 1px solid #1f6b47;
    }
    .health-warn {
      background: #3b2b12;
      color: #ffd47f;
      border: 1px solid #8b6a1a;
    }
    .health-bad {
      background: #3b1218;
      color: #ff9ba9;
      border: 1px solid #a5303f;
    }
    .health-dot {
      width: 0.6rem;
      height: 0.6rem;
      border-radius: 999px;
      background: currentColor;
    }

    .stats-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      margin-bottom: 1rem;
      font-size: 0.85rem;
    }
    .stat-pill {
      background: #151a2f;
      padding: 0.4rem 0.7rem;
      border-radius: 999px;
      border: 1px solid #22263a;
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
    }
    .stat-label {
      opacity: 0.7;
    }
    .stat-value {
      font-weight: 600;
      font-feature-settings: "tnum" 1;
      font-variant-numeric: tabular-nums;
    }

    .error {
      padding: 0.7rem 1rem;
      background: #3b1218;
      border-left: 4px solid #ff6b81;
      margin-bottom: 1rem;
      font-size: 0.9rem;
      display: none;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.5rem;
    }
    th, td {
      padding: 0.4rem 0.5rem;
      text-align: left;
      border-bottom: 1px solid #22263a;
      font-size: 0.9rem;
      white-space: nowrap;
    }
    th {
      background: #151a2f;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    tr:nth-child(even) {
      background: #101426;
    }

    .status-pill {
      display: inline-block;
      padding: 0.1rem 0.5rem;
      border-radius: 999px;
      font-size: 0.8rem;
      font-weight: 600;
    }
    .sync-ok { background: #16331f; color: #5be481; }
    .sync-running { background: #302511; color: #ffc857; }
    .sync-pending { background: #202943; color: #9db8ff; }
    .sync-error { background: #3b1218; color: #ff6b81; }

    .req-idle { background: #283043; color: #c7d0ff; }
    .req-backfill { background: #2b1c4b; color: #e8b4ff; }
    .req-gap_fill { background: #2b2235; color: #fdd280; }
    .req-live { background: #073424; color: #68f0bd; }

    .stale-yes { color: #ff6b81; font-weight: 600; }
    .stale-no  { color: #68f0bd; }

    .age {
      font-feature-settings: "tnum" 1;
      font-variant-numeric: tabular-nums;
      opacity: 0.9;
    }

    .small {
      font-size: 0.8rem;
      opacity: 0.8;
    }

    .footer-note {
      margin-top: 1rem;
      font-size: 0.8rem;
      opacity: 0.7;
    }
  </style>
</head>
<body>
  <div class="header">
    <div>
      <h1>Feature Service Status</h1>
      <div class="meta">
        Feature version:
        <strong id="feature-version">{{ feature_version }}</strong> ·
        Timeframes:
        <strong id="feature-timeframes">{{ timeframes }}</strong>
      </div>
    </div>
    <div id="global-health" class="health-bar health-warn">
      <span class="health-dot"></span>
      <span id="global-health-text">Loading…</span>
    </div>
  </div>

  <div class="stats-row">
    <div class="stat-pill">
      <span class="stat-label">Symbols</span>
      <span id="stat-total" class="stat-value">0</span>
    </div>
    <div class="stat-pill">
      <span class="stat-label">OK / live</span>
      <span id="stat-ok-live" class="stat-value">0</span>
    </div>
    <div class="stat-pill">
      <span class="stat-label">Running</span>
      <span id="stat-running" class="stat-value">0</span>
    </div>
    <div class="stat-pill">
      <span class="stat-label">Pending</span>
      <span id="stat-pending" class="stat-value">0</span>
    </div>
    <div class="stat-pill">
      <span class="stat-label">Error</span>
      <span id="stat-error" class="stat-value">0</span>
    </div>
    <div class="stat-pill">
      <span class="stat-label">Feature stale</span>
      <span id="stat-stale" class="stat-value">0</span>
    </div>
    <div class="stat-pill">
      <span class="stat-label">Last refresh</span>
      <span id="stat-last-refresh" class="stat-value">–</span>
    </div>
  </div>

  <div id="error-banner" class="error"></div>

  <table>
    <thead>
      <tr>
        <th>Symbol</th>
        <th>Market</th>
        <th>Sync</th>
        <th>Request</th>
        <th>Last feature time</th>
        <th>Age</th>
        <th>Row last_updated</th>
      </tr>
    </thead>
    <tbody id="status-body">
      <!-- Filled by JS -->
    </tbody>
  </table>

  <p class="footer-note">
    Staleness threshold (in JS): 300 s for features. Adjust in <code>feature_dashboard.html</code> as needed.
  </p>

  <script>
    const REFRESH_INTERVAL_MS = 5000;       // 5 seconds
    const FEATURE_STALE_THRESHOLD = 300;    // 300 seconds (5 minutes)

    async function fetchStatus() {
      const errorBanner = document.getElementById("error-banner");
      try {
        const res = await fetch("/api/feature_status", { cache: "no-store" });
        if (!res.ok) {
          throw new Error("HTTP " + res.status);
        }
        const data = await res.json();

        // Update header meta from API
        if (data.version !== undefined) {
          document.getElementById("feature-version").textContent = data.version;
        }
        if (data.timeframes !== undefined) {
          document.getElementById("feature-timeframes").textContent =
            Array.isArray(data.timeframes) ? data.timeframes.join(", ") : data.timeframes;
        }

        // Backend error (e.g., DB down)
        if (data.error) {
          errorBanner.textContent = data.error;
          errorBanner.style.display = "block";
        } else {
          errorBanner.textContent = "";
          errorBanner.style.display = "none";
        }

        const symbols = data.symbols || [];
        renderTable(symbols);
        renderStats(symbols);

        const now = new Date();
        document.getElementById("stat-last-refresh").textContent =
          now.toLocaleTimeString();

      } catch (err) {
        console.error("Fetch error:", err);
        errorBanner.textContent = "Failed to fetch feature status: " + err;
        errorBanner.style.display = "block";
      }
    }

    function renderTable(symbols) {
      const tbody = document.getElementById("status-body");
      tbody.innerHTML = "";

      for (const r of symbols) {
        const ageSec = r.kline_feature_last_time_age_sec;
        const stale = ageSec !== null && ageSec > FEATURE_STALE_THRESHOLD;

        const ageStr = ageSec === null
          ? "n/a"
          : Math.floor(ageSec) + " s";

        const syncClass = "sync-" + (r.sync_status || "pending");
        const reqClass = "req-" + (r.request_status || "idle");

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${r.symbol ?? "–"}</td>
          <td>${r.market_type ?? "–"}</td>
          <td>
            <span class="status-pill ${syncClass}">${r.sync_status}</span>
          </td>
          <td>
            <span class="status-pill ${reqClass}">${r.request_status}</span>
          </td>
          <td>${r.kline_feature_last_time ?? "–"}</td>
          <td class="age">
            ${
              ageSec === null
                ? '<span class="small">n/a</span>'
                : `<span class="${stale ? "stale-yes" : "stale-no"}">${ageStr}</span>`
            }
          </td>
          <td>${r.last_updated ?? "–"}</td>
        `;
        tbody.appendChild(tr);
      }
    }

    function renderStats(symbols) {
      const total = symbols.length;
      let okLive = 0;
      let running = 0;
      let pending = 0;
      let error = 0;
      let staleCount = 0;

      for (const r of symbols) {
        if (r.sync_status === "ok" && r.request_status === "live") {
          okLive += 1;
        }
        if (r.sync_status === "running") {
          running += 1;
        }
        if (r.sync_status === "pending") {
          pending += 1;
        }
        if (r.sync_status === "error") {
          error += 1;
        }

        const ageSec = r.kline_feature_last_time_age_sec;
        if (ageSec !== null && ageSec > FEATURE_STALE_THRESHOLD) {
            staleCount += 1;
        }
      }

      document.getElementById("stat-total").textContent = total;
      document.getElementById("stat-ok-live").textContent = okLive;
      document.getElementById("stat-running").textContent = running;
      document.getElementById("stat-pending").textContent = pending;
      document.getElementById("stat-error").textContent = error;
      document.getElementById("stat-stale").textContent = staleCount;

      const healthDiv = document.getElementById("global-health");
      const healthText = document.getElementById("global-health-text");

      let healthClass = "health-warn";
      let text = "Degraded";

      if (total === 0) {
        healthClass = "health-warn";
        text = "No symbols";
      } else if (error > 0) {
        healthClass = "health-bad";
        text = "Errors present";
      } else if (staleCount === 0 && running === 0 && pending === 0) {
        healthClass = "health-ok";
        text = "Healthy";
      } else if (staleCount === total) {
        healthClass = "health-bad";
        text = "All stale";
      } else {
        healthClass = "health-warn";
        text = "Mixed";
      }

      healthDiv.classList.remove("health-ok", "health-warn", "health-bad");
      healthDiv.classList.add(healthClass);
      healthText.textContent = text;
    }

    fetchStatus();
    setInterval(fetchStatus, REFRESH_INTERVAL_MS);
  </script>
</body>
</html>
